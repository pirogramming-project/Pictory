{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_MAP_APPKEY_JS}}&libraries=services"></script>
<link rel="stylesheet" href="{% static 'diaries/create_diary.css' %}">
{% endblock %}

{% block content %}
    <div class="create_diary_container_ksy">

        <div class="create_diary_left_container_psy">
            <img src="{{related_frame_img.url}}">
        </div>

        <div class="create_diary_right_container_psy">
            <form class="create_diary_form_psy" method="post" action="{% url 'diaries:create_diary' related_frame_id %}">
                {% csrf_token %}
                <input type="hidden" id="create_diary_real_address" name="place_address">
                <div class="first_right_container_psy">
                    <div class="first_line_psy">
                        <div class="diary_title_psy">
                            <h1 class="diary_letter_psy">o Title</h1>
                            {{ form.title }}
                        </div>
                        <div class="diary_date_psy">
                            <h1 class="diary_letter_psy">o Date</h1>
                            {{ form.date }}
                        </div>
                    </div>
    
                    <div class="second_line_psy">
                        
                        <div class="diary_weather_psy">
                            <h1 class="diary_letter_psy">o Weather</h1>
                            {{ form.weather|safe }}
                        </div>
                        <div class="diary_emotion_psy">
                            <h1 class="diary_letter_psy">o Emotion</h1>
                            {{ form.emotion|safe }}
                        </div>
                    </div>
    
                    <div class="third_line_psy">
    
                        <div class="diary_tag_psy">
                            <div class="diary_content_tag_psy">
                                <h1 class="diary_letter_psy">o Tag</h1>
                                <input type="text" name="create_diary_post" placeholder="#ÏúºÎ°ú ÌÉúÍ∑∏Î•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî" class="content_tag_psy" required>
                            </div>
                            <div class="diary_friend_psy">
                                <h1 class="diary_letter_psy">o Friend Tag</h1>
                                {% comment %} ÏàòÏ†ïÌïú Î∂ÄÎ∂Ñ {% endcomment %}
                                {% for user in neighbors %} 
                                    <div class="friend_tag_item_psy">
                                        <input type="checkbox" name="user_tags" value="{{ user.login_id }}" id="friend_{{ user.login_id }}">
                                        <label for="friend_{{ user.login_id }}">{{ user.nickname }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
    
                        <div class="diary_map_psy">
                            <h1 class="diary_letter_psy">o Location</h1>
                            {{ form.place }}
                            <ul id="placesList"></ul>
                            <div class="real_location_psy"></div>
                            <!-- Ïû•ÏÜå Î™©Î°ù Ï∂úÎ†• ÏòÅÏó≠ -->

                        </div>
                    </div>
                </div>
                
                <div class="fourth_line_psy">
                    <h1 class="diary_letter_psy">o Content</h1>
                    {{ form.content }}
                </div>

                <button type="submit" class="diary_save_psy">
                    <p>Save</p>
                </button>
            </form>
            
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const inputField = document.querySelector("#id_place");
            const placesList = document.getElementById("placesList");
            const mapContainer = document.querySelector(".real_location_psy");
            const geocoder = new kakao.maps.services.Geocoder();
            const ps = new kakao.maps.services.Places();
            let marker;
            let topPlace = null;
            const map = new kakao.maps.Map(mapContainer, {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // ÏÑúÏö∏ÏãúÏ≤≠ Ï§ëÏã¨ Ï¢åÌëú
                level: 6, // ÏßÄÎèÑ ÌôïÎåÄ Î†àÎ≤®
            });
    
            // ÏπúÍµ¨ ÌÉúÍ∑∏ ÏÑ†ÌÉù Í∏∞Îä•
            document.querySelectorAll(".friend_tag_item_psy").forEach(function (tagItem) {
                const checkbox = tagItem.querySelector("input[type='checkbox']");
                if (checkbox.checked) {
                    tagItem.classList.add("selected");
                }
                tagItem.addEventListener("click", function () {
                    checkbox.checked = !checkbox.checked;
                    tagItem.classList.toggle("selected", checkbox.checked);
                });
            });
    
            // üîπ input ÌÅ¥Î¶≠ ÎòêÎäî ÏûÖÎ†• Ïãú Ïû•ÏÜå Î™©Î°ù Ï†úÏñ¥
            inputField.addEventListener("focus", function () {
                if (placesList.innerHTML.trim() !== "") {
                    placesList.style.display = "flex";
                }
            });
    
            inputField.addEventListener("input", function () {
                const keyword = this.value.trim();
                if (keyword) {
                    placeSearch(keyword);
                } else {
                    placesList.innerHTML = "";
                    placesList.style.display = "none";
                }
            });
    
            inputField.addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    selectTopPlace();
                }
            });
    
            function placeSearch(keyword) {
                ps.keywordSearch(keyword, function (data, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        topPlace = data[0];
                        displayPlaces(data.slice(0, 3));
                        placesList.style.display = "flex";
                    } else {
                        placesList.style.display = "none";
                    }
                });
            }
    
            function displayPlaces(places) {
                placesList.innerHTML = "";
                places.forEach((place, index) => {
                    const itemEl = document.createElement("li");
                    itemEl.innerHTML = `
                        <span class="markerbg marker_${index + 1}"></span>
                        <div class="info">
                            <h5>${place.place_name}</h5>
                            <span>${place.road_address_name || place.address_name}</span>
                        </div>
                    `;
                    itemEl.addEventListener("click", function () {
                        addLocation(place.address_name);
                        placesList.style.display = "none";
                    });
                    placesList.appendChild(itemEl);
                });
            }
    
            function selectTopPlace() {
                if (topPlace) {
                    addLocation(topPlace.address_name);
                    placesList.style.display = "none";
                } else {
                    alert("Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.");
                }
            }
    
            function addLocation(address) {
                geocoder.addressSearch(address, function (result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        if (marker) {
                            marker.setMap(null);
                        }
                        marker = new kakao.maps.Marker({ position: coords });
                        marker.setMap(map);
                        map.panTo(coords);
                        document.getElementById("create_diary_real_address").value = address;
                    } else {
                        alert("Ïû•ÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                    }
                });
            }
    
            // üîπ Save Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Í≤ÄÏ¶ù
            document.querySelector(".diary_save_psy").addEventListener("click", function (event) {
                const weatherInputs = document.querySelectorAll('input[name="weather"]');
                const emotionInputs = document.querySelectorAll('input[name="emotion"]');
    
                const weatherSelected = Array.from(weatherInputs).some(input => input.checked);
                const emotionSelected = Array.from(emotionInputs).some(input => input.checked);
    
                if (!weatherSelected || !emotionSelected) {
                    event.preventDefault();
                    if (!weatherSelected) alert("ÎÇ†Ïî®Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!");
                    if (!emotionSelected) alert("Í∞êÏ†ïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!");
                }
            });
        });
    </script>
    
{% endblock %}