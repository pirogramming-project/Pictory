{% load static %}
<h3>o ìŠ¤í‹°ì»¤ ì„ íƒ</h3>
<div class="stickers_list_kes">
    {% for sticker in sticker_files %}
    <img src="{% static "images/stickers/" %}{{ sticker }}" class="sticker_psy" onclick="addSticker_psy(this)">
    {% endfor %}
</div>
<button class="pagesThickness_button_complete" onclick="resetCustomizeField_kes()">
    <span class="pagesThickness_text_ksy">Save</span>
</button>
<script>
    function addSticker_psy(sticker_psy) {
        const pictoryFrame_psy = document.getElementById("pictory-frame_psy");
        const newStickerContainer = document.createElement('div');
        newStickerContainer.className = "added_sticker_container_kes";
        newStickerContainer.draggable="true";
        newStickerContainer.style.position = "absolute";
        newStickerContainer.style.left = "20px";
        newStickerContainer.style.top = "20px";
        const newSticker_psy = document.createElement("img");
        newSticker_psy.src = sticker_psy.src;
        newSticker_psy.className = "added_sticker_kes";
        newSticker_psy.style.width = `60px`;
        addImageDragEventListeners_kes(newStickerContainer);

        // ì—¬ê¸°ë¶€í„° ìŠ¤í‹°ì»¤ ì œê±°, í¬ê¸°ì¡°ì ˆ ìœ„í•œ ì½”ë“œ
        const stickerTool_Container = document.createElement('div');
        stickerTool_Container.className = "sticker_tools_container";
        // 1. ìŠ¤í‹°ì»¤ ì œê±°
        const closeButton = document.createElement('button');
        closeButton.className = "sticker_remove_btn_kes";
        closeButton.textContent = "X";
        closeButton.addEventListener("click", () => {
            newStickerContainer.remove();
        });
        // 2. í¬ê¸°ì¡°ì ˆ
        const resizeHandle = document.createElement('div');
        resizeHandle.className = "sticker_resize_handle_kes";
        resizeHandle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707m4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707"/>
        </svg>`;
        let isResizing = false;
        let aspectRatio = newSticker_psy.naturalWidth / newSticker_psy.naturalHeight;
        let startX, startY, startWidth, startHeight;
        resizeHandle.addEventListener("mousedown", (event) => {
            isResizing = true;
            startX = event.clientX;
            startY = event.clientY;
            startWidth = newSticker_psy.offsetWidth;
            startHeight = newSticker_psy.offsetHeight;
            event.preventDefault();
        });
        document.addEventListener("mousemove", (event) => {
            if (!isResizing) return;
            let dx = event.clientX - startX;
            let dy = event.clientY - startY;
            let newSize = Math.max(startWidth + dx, startHeight + dy * aspectRatio); // ë¹„ìœ¨ ìœ ì§€
            newSticker_psy.style.width = `${Math.max(newSize, 40)}px`;
            newSticker_psy.style.height = `${Math.max(newSize / aspectRatio, 40)}px`;
        });
        document.addEventListener("mouseup", () => {
            isResizing = false;
        });


        // DOMìš”ì†Œ ì¶”ê°€
        newStickerContainer.addEventListener('click', (event) => {
            event.stopPropagation();
            stickerTool_Container.style.display = 'flex';
        });
        document.addEventListener('click', (event) => {
            stickerTool_Container.style.display = 'none';
        });
        stickerTool_Container.appendChild(closeButton);
        stickerTool_Container.appendChild(resizeHandle);
        newStickerContainer.appendChild(newSticker_psy);
        newStickerContainer.appendChild(stickerTool_Container);
        pictoryFrame_psy.appendChild(newStickerContainer);
    }

    function addImageDragEventListeners_kes(draggableImg) {
        let offsetX = 0, offsetY = 0;
        const container = document.getElementById("pictory-frame_psy");
    
        // ğŸ–¥ ë°ìŠ¤í¬í†±ìš© ë“œë˜ê·¸ ì´ë²¤íŠ¸
        draggableImg.addEventListener("dragstart", (e) => {
            offsetX = e.offsetX;
            offsetY = e.offsetY;
            e.dataTransfer.setData("text/plain", ""); // ê¸°ë³¸ ë“œë˜ê·¸ ë™ì‘ ë°©ì§€
        });
    
        draggableImg.addEventListener("drag", (e) => {
            if (e.clientX === 0 && e.clientY === 0) return; // ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ë¬´ì‹œ
    
            const parentRect = container.getBoundingClientRect();
            const imgWidth = draggableImg.offsetWidth - 20;
            const imgHeight = draggableImg.offsetHeight - 20;
    
            let newX = e.clientX - parentRect.left - offsetX;
            let newY = e.clientY - parentRect.top - offsetY;
    
            // ë¶€ëª¨ ì˜ì—­ ë‚´ì—ì„œë§Œ ì´ë™
            newX = Math.max(0, Math.min(newX, parentRect.width - imgWidth));
            newY = Math.max(0, Math.min(newY, parentRect.height - imgHeight));
    
            draggableImg.style.left = `${newX}px`;
            draggableImg.style.top = `${newY}px`;
        });
    
        draggableImg.addEventListener("dragover", (e) => {
            e.preventDefault(); // ê¸°ë³¸ ë“œë˜ê·¸ ë™ì‘ ë°©ì§€
        });
    
        draggableImg.addEventListener("drop", (e) => {
            e.preventDefault();
        });
    
        // ğŸ“± ëª¨ë°”ì¼ìš© í„°ì¹˜ ì´ë²¤íŠ¸
        let touchStartX = 0, touchStartY = 0;
        let touchMoved = false;
    
        draggableImg.addEventListener("touchstart", (e) => {
            const touch = e.touches[0]; // ì²« ë²ˆì§¸ í„°ì¹˜ ê°€ì ¸ì˜¤ê¸°
            const rect = draggableImg.getBoundingClientRect();
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchMoved = false; // í„°ì¹˜ ì‹œì‘ ì‹œ ì´ë™ ì—¬ë¶€ ì´ˆê¸°í™”
        });
    
        draggableImg.addEventListener("touchmove", (e) => {
            e.preventDefault(); // ê¸°ë³¸ í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€
            touchMoved = true; // í„°ì¹˜ê°€ ì›€ì§ì˜€ìŒì„ ê¸°ë¡
    
            const touch = e.touches[0];
            const parentRect = container.getBoundingClientRect();
            const imgWidth = draggableImg.offsetWidth - 20;
            const imgHeight = draggableImg.offsetHeight - 20;
    
            let newX = touch.clientX - parentRect.left - (draggableImg.offsetWidth / 2);
            let newY = touch.clientY - parentRect.top - (draggableImg.offsetHeight / 2);
    
            // ë¶€ëª¨ ì˜ì—­ ë‚´ì—ì„œë§Œ ì´ë™
            newX = Math.max(0, Math.min(newX, parentRect.width - imgWidth));
            newY = Math.max(0, Math.min(newY, parentRect.height - imgHeight));
    
            draggableImg.style.left = `${newX}px`;
            draggableImg.style.top = `${newY}px`;
        });
    
        draggableImg.addEventListener("touchend", (e) => {
            e.preventDefault(); // í„°ì¹˜ ì¢…ë£Œ ì‹œ ë¶ˆí•„ìš”í•œ ì´ë²¤íŠ¸ ë°©ì§€
    
            // í„°ì¹˜ ì´ë™ì´ ê±°ì˜ ì—†ì—ˆë‹¤ë©´ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ íŠ¸ë¦¬ê±°
            if (!touchMoved) {
                draggableImg.click(); // í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ë™ ì‹¤í–‰
            }
        });
    }
    
</script>
