{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <meta name="csrf_token" content="{{ csrf_token }}">    
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_MAP_APPKEY_JS}}&libraries=services"></script>
    <link rel="stylesheet" href="{% static 'diaries/diary_map.css' %}">
{% endblock %}

{% block content %}
<!--ì§€ë„ ì˜ì—­-->
<div class="map_container_ksy">
    <div class="map_map-container_kes">
        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <div class="map_search-container_ksy">
            <form class="map_search-form_ksy">
                {% csrf_token %}
                <input type="text" class="map_search-input_ksy" placeholder="ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”" required>
                <button type="submit" class="map_search-button-container_ksy">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="map_search-button_ksy" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                      </svg>
                </button>
            </form>
        </div>
    </div>
  </div>

  <!-- í•´ë‹¹ ì¥ì†Œì™€ ê´€ë ¨ëœ ì¼ê¸° ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
<div class="map_diary-list_ljs">
  <ul id="diaryListContainer"></ul>
</div>
  

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const placeDataText = "{{ my_places_address|escapejs }}";
        const myPlacesAddress = JSON.parse(placeDataText.replace(/'/g, '"'));

        for (let i=0; i<myPlacesAddress.length; i++) {
            placeSearchAndAddMarkers(myPlacesAddress[i]);
        }

        const searchForm = document.querySelector('.map_search-form_ksy');
        searchForm.addEventListener("submit", function (event) {
          event.preventDefault(); // ìƒˆë¡œê³ ì¹¨ ë°©ì§€
          const inputValue = document.querySelector(".map_search-input_ksy").value;
          placeSearchAndJustMoveMapCenter(inputValue);
      });

    });
    // 1. ì§€ë„ ì´ˆê¸°í™”
    const mapContainer = document.querySelector('.map_map-container_kes');
    const map = new kakao.maps.Map(mapContainer, {
      center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­ ì¤‘ì‹¬ ì¢Œí‘œ
      level: 9, // ì§€ë„ í™•ëŒ€ ë ˆë²¨
    });

    const geocoder = new kakao.maps.services.Geocoder(); // ì£¼ì†Œ ê²€ìƒ‰ ê°ì²´
    const markers = {}; // ë§ˆì»¤ ì €ì¥ ê°ì²´

    // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var ps = new kakao.maps.services.Places(); 

    function placeSearchAndAddMarkers(place_address) {
      addLocation(place_address); 
    }

    function placeSearchAndJustMoveMapCenter(keyword) {
      ps.keywordSearch(keyword, moveCenterCB); 
    }

    // í‚¤ì›Œë“œ ê²€ìƒ‰ ì™„ë£Œ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜ ì…ë‹ˆë‹¤
    function addMarkerCB (data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {
          targetPlace = data[0];  // ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ì¥ì†Œë¥¼ íƒ€ê²Ÿìœ¼ë¡œ ì„¤ì •
          console.log(targetPlace['address_name'])  // ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°

            // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•˜ê¸°ìœ„í•´
            // LatLngBounds ê°ì²´ì— ì¢Œí‘œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
            var bounds = new kakao.maps.LatLngBounds();
            bounds.extend(new kakao.maps.LatLng(data[0].y, data[0].x));

            // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•©ë‹ˆë‹¤
            map.setBounds(bounds);

            addLocation(targetPlace['address_name']);
        } else {
          
        }
    }

    function moveCenterCB (data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {
          targetPlace = data[0];  // ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ì¥ì†Œë¥¼ íƒ€ê²Ÿìœ¼ë¡œ ì„¤ì •
          console.log(targetPlace['address_name'])  // ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°

            // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•˜ê¸°ìœ„í•´
            // LatLngBounds ê°ì²´ì— ì¢Œí‘œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
            var bounds = new kakao.maps.LatLngBounds();
            bounds.extend(new kakao.maps.LatLng(data[0].y, data[0].x));

            // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ë²”ìœ„ë¥¼ ì¬ì„¤ì •í•©ë‹ˆë‹¤
            map.setBounds(bounds);
        } else {
          
        }
    }

    // 2. ë§ˆì»¤ ì¶”ê°€ í•¨ìˆ˜
    function addLocation(address) {
      const input = address;

      if (!input) {
        return;
      }

      // 2.1. ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜
      geocoder.addressSearch(input, function (result, status) {
        if (status === kakao.maps.services.Status.OK) {
          const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
          const addressName = result[0].address_name;

          // 2.2. ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë§ˆì»¤ì¸ì§€ í™•ì¸
          if (markers[addressName]) {
            // ì¹´ìš´í„° ì¦ê°€
            const markerData = markers[addressName];
            markerData.count++;
            markerData.label.setContent(`<span class="marker-label">${markerData.count}</span>`);
          } else {
            // ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
            const marker = new kakao.maps.Marker({
              position: coords,
              map: map,
            });

            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            kakao.maps.event.addListener(marker, 'click', function () {
              fetchDiariesByPlace(input); // ë‹¤ì´ì–´ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            });

            const label = new kakao.maps.CustomOverlay({
              position: coords,
              content: `<span class="marker-label">1</span>`,
              yAnchor: 1.5, // ë§ˆì»¤ ìœ„ì— í‘œì‹œ
            });

            label.setMap(map);

            // ë§ˆì»¤ ë°ì´í„° ì €ì¥
            markers[addressName] = {
              marker: marker,
              label: label,
              count: 1,
            };
          }

          // ì§€ë„ ì¤‘ì‹¬ ì´ë™
          //map.panTo(coords);
        } else {
            
        }
      });
    }

    function fetchDiariesByPlace(address) {
      const url = `/diary/diaries_by_place_ajax/`;
      var csrftoken = document.querySelector("meta[name=csrf_token]").content;
      console.log("add:" + address)
      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          address: address,
        }),
      })
          .then(response => response.json())
          .then(data => {
              displayDiaryList(data);
          })
          .catch(error => {
              console.error("Error fetching diaries:", error);
          });
  }

  function displayDiaryList(diaries) {
    const diaryListContainer = document.getElementById("diaryListContainer");

    diaryListContainer.innerHTML = ""; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

    if (diaries.length === 0) {
        diaryListContainer.innerHTML = "<li>ğŸ“Œ ê´€ë ¨ëœ ë‹¤ì´ì–´ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
    } else {
        diaries.forEach(diary => {
            const listItem = document.createElement("li");
            const link = document.createElement("a");

            link.href = `/diary/detail/${diary.id}/`;
            link.textContent = `${diary.place} - ${diary.title}`;

            listItem.appendChild(link);
            diaryListContainer.appendChild(listItem);
        });
    }
  }



    
</script>
{% endblock %}