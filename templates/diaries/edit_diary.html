{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_MAP_APPKEY_JS}}&libraries=services"></script>
<link rel="stylesheet" href="{% static 'diaries/edit_diary.css' %}">
{% endblock %}

{% block content %}
<div class="create_diary_container_ksy">

    <div class="create_diary_left_container_psy">
        <img src="{{ diary.four_cut_photo.image_file.url }}" alt="ÏÇ¨Ïö©Ïûê ÏóÖÎ°úÎìú ÏÇ¨ÏßÑ">
    </div>

    <div class="create_diary_right_container_psy">
        <form class="create_diary_form_psy" method="post" action="{% url 'diaries:edit_diary' diary.id %}">
            {% csrf_token %}
            <input type="hidden" id="create_diary_real_address" name="place_address">
            <div class="first_right_container_psy">
                <div class="first_line_psy">
                    <div class="diary_title_psy">
                        <h1 class="diary_letter_psy">o Title</h1>
                        {{ form.title }}
                    </div>
                    <div class="diary_date_psy">
                        <h1 class="diary_letter_psy">o Date</h1>
                        {{ form.date }}
                    </div>
                </div>

                <div class="second_line_psy">
                    <div class="diary_weather_psy">
                        <h1 class="diary_letter_psy">o Weather</h1>
                        {{ form.weather|safe }}
                    </div>
                    <div class="diary_emotion_psy">
                        <h1 class="diary_letter_psy">o Emotion</h1>
                        {{ form.emotion|safe }}
                    </div>
                </div>

                <div class="third_line_psy">

                    <div class="diary_tag_psy">
                        <div class="diary_content_tag_psy">
                            <h1 class="diary_letter_psy">o Tag</h1>
                            <input type="text" placeholder="ÌÉúÍ∑∏Î•º Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî" class="content_tag_psy">
                            <button type="button" id="addTagBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
                                  </svg>
                            </button>
                            <div class="tag-container" id="tagContainer"></div>
                            <input type="hidden" name="create_diary_post" id="tagsInput">
                        </div>
                        <div class="diary_friend_psy">
                            <h1 class="diary_letter_psy">o Friend Tag</h1>
                            {% comment %} ÏàòÏ†ïÌïú Î∂ÄÎ∂Ñ {% endcomment %}
                            {% for user in neighbors %}
                                <div class="friend_tag_item_psy">
                                    <input type="checkbox" name="user_tags" value="{{ user.login_id }}" id="friend_{{ user.login_id }}"
                                        {% if user in form.instance.user_tags.all %}checked{% endif %}>  <!-- Í∏∞Ï°¥ ÏÑ†ÌÉùÎêú Í∞í Ïú†ÏßÄ -->
                                    <label for="friend_{{ user.login_id }}">{{ user.nickname }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="diary_map_psy">
                        <h1 class="diary_letter_psy">o Location</h1>
                        <div class="create_input_button_ksy">
                            {{ form.place }}
                            <button class="placeListOnclick">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                                </svg>
                            </button>
                        </div>
                        <ul id="placesList"></ul>
                        <div class="real_location_psy"></div>
                        <!-- Ïû•ÏÜå Î™©Î°ù Ï∂úÎ†• ÏòÅÏó≠ -->

                    </div>

                </div>
            </div>
            
            <div class="fourth_line_psy">
                <h1 class="diary_letter_psy">o Content</h1>
                {{ form.content }}
            </div>

            <button type="submit" class="diary_save_psy">
                <span>Save</span>
            </button>
        </form>
        
    </div>
</div>
<script>
    const geocoder = new kakao.maps.services.Geocoder();
    const inputField = document.querySelector("#id_place");
    const placesList = document.getElementById("placesList");
    const mapContainer = document.querySelector(".real_location_psy");
    const ps = new kakao.maps.services.Places();
    let marker;
    let topPlace = null;
    const map = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // ÏÑúÏö∏ÏãúÏ≤≠ Ï§ëÏã¨ Ï¢åÌëú
        level: 6, // ÏßÄÎèÑ ÌôïÎåÄ Î†àÎ≤®
    });

    document.addEventListener("DOMContentLoaded", function() {
        InitFriendTag();
        InitTagInput();
        InitPlaceInput();

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏßÄÎèÑ ÌïÄ Ï∞çÍ∏∞
        const placeName = document.getElementById("id_place").value;
        addLocation("{{ diary.place_address }}");
    });

    function InitFriendTag() {
        // Î™®Îì† ÏπúÍµ¨ ÌÉúÍ∑∏ ÏöîÏÜåÎ•º Í∞ÄÏ†∏Ïò¥
        let friendTags = document.querySelectorAll(".friend_tag_item_psy");

        friendTags.forEach(function(tagItem) {
            let checkbox = tagItem.querySelector("input[type='checkbox']");
            
            // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï (Ï≤¥ÌÅ¨ÎêòÏóàÏùÑ Í≤ΩÏö∞ ÏÉâÏÉÅ Î≥ÄÍ≤Ω)
            if (checkbox.checked) {
                tagItem.classList.add("selected");
            }

            // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            tagItem.addEventListener("click", function() {
                checkbox.checked = !checkbox.checked; // Ï≤¥ÌÅ¨ ÏÉÅÌÉú ÌÜ†Í∏Ä

                if (checkbox.checked) {
                    tagItem.classList.add("selected"); // ÏÑ†ÌÉù Ïãú ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                } else {
                    tagItem.classList.remove("selected"); // ÏÑ†ÌÉù Ï∑®ÏÜå Ïãú ÏõêÎûò ÏÉâÏúºÎ°ú Î≥ÄÍ≤Ω
                }
            });
        });
    }


    function InitPlaceInput() {
        // ÏπúÍµ¨ ÌÉúÍ∑∏ ÏÑ†ÌÉù Í∏∞Îä•
        document.querySelectorAll(".friend_tag_item_psy").forEach(function (tagItem) {
            const checkbox = tagItem.querySelector("input[type='checkbox']");
            if (checkbox.checked) {
                tagItem.classList.add("selected");
            }
            tagItem.addEventListener("click", function () {
                checkbox.checked = !checkbox.checked;
                tagItem.classList.toggle("selected", checkbox.checked);
            });
        });   

        function placeSearch(keyword) {
            ps.keywordSearch(keyword, function (data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    topPlace = data[0];
                    displayPlaces(data.slice(0, 3));
                    placesList.style.display = "flex";
                } else {
                    placesList.style.display = "none";
                }
            });
        }

        function displayPlaces(places) {
            placesList.innerHTML = "";
            places.forEach((place, index) => {
                const itemEl = document.createElement("li");
                itemEl.innerHTML = `
                    <span class="markerbg marker_${index + 1}"></span>
                    <div class="info">
                        <h5>${place.place_name}</h5>
                        <span>${place.road_address_name || place.address_name}</span>
                    </div>
                `;
                itemEl.addEventListener("click", function () {
                    addLocation(place.address_name);
                    placesList.style.display = "none";
                });
                placesList.appendChild(itemEl);
            });
        }

        function selectTopPlace() {
            if (topPlace) {
                addLocation(topPlace.address_name);
                placesList.style.display = "none";
            } else {
                alert("Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.");
            }
        }



        // üîπ Save Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Í≤ÄÏ¶ù
        document.querySelector(".diary_save_psy").addEventListener("click", function (event) {
            const weatherInputs = document.querySelectorAll('input[name="weather"]');
            const emotionInputs = document.querySelectorAll('input[name="emotion"]');

            const weatherSelected = Array.from(weatherInputs).some(input => input.checked);
            const emotionSelected = Array.from(emotionInputs).some(input => input.checked);

            if (!weatherSelected || !emotionSelected) {
                <!-- event.preventDefault(); -->
                if (!weatherSelected) alert("ÎÇ†Ïî®Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!");
                if (!emotionSelected) alert("Í∞êÏ†ïÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!");
            }
        });

        document.querySelector('.placeListOnclick').addEventListener('click', () => {
            event.preventDefault();
            placeSearch(inputField.value)
        });

        inputField.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                placeSearch(inputField.value);
            }
        });

    }

    function InitTagInput() {
        const tagInput = document.querySelector('.content_tag_psy');
        const addTagBtn = document.getElementById("addTagBtn");
        const tagContainer = document.getElementById("tagContainer");
        const tagsInput = document.getElementById("tagsInput");
        let tags = [];
        
        function addTag(tag) {
            if (!tag || tags.includes(tag)) return; // Ï§ëÎ≥µ Î∞©ÏßÄ
            tags.push(tag);
            
            // ÌÉúÍ∑∏ UI Ï∂îÍ∞Ä
            const tagElement = document.createElement("div");
            tagElement.classList.add("tag");
            tagElement.innerHTML = `#${tag} <button class="remove">x</button>`;
            tagContainer.appendChild(tagElement);
            console.log(tagElement.querySelector(".remove"))
            // ÏÇ≠Ï†ú Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            tagElement.querySelector(".remove").addEventListener("click", () => {
                console.log("ÏÇ≠Ï†úÏÇ≠Ï†ú");
                tags = tags.filter(t => t !== tag);
                tagElement.remove();
                updateHiddenInput();
            });

            updateHiddenInput();
        }

        function updateHiddenInput() {
            tagsInput.value = tags.join("#");
        }

        // ÏóîÌÑ∞ ÌÇ§ ÏûÖÎ†• Ïãú ÌÉúÍ∑∏ Ï∂îÍ∞Ä
        tagInput.addEventListener("keypress", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                addTag(tagInput.value.trim());
                tagInput.value = ""; // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
            }
        });
            
        // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÌÉúÍ∑∏ Ï∂îÍ∞Ä
        addTagBtn.addEventListener("click", () => {
            addTag(tagInput.value.trim());
            tagInput.value = ""; // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
        });

        const diaryTags = JSON.parse('{{ diary_tags|safe }}');  
        
        diaryTags.forEach(tag => {
            addTag(tag.name);
        });

    }

    function addLocation(address) {
        geocoder.addressSearch(address, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                if (marker) {
                    marker.setMap(null);
                }
                marker = new kakao.maps.Marker({ position: coords });
                marker.setMap(map);
                map.panTo(coords);
                document.getElementById("create_diary_real_address").value = address;
            } else {
                alert("Ïû•ÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            }
        });
    }
    </script>


{% endblock %}
