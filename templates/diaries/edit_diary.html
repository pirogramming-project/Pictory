{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_MAP_APPKEY_JS}}&libraries=services"></script>
<link rel="stylesheet" href="{% static 'diaries/edit_diary.css' %}">
{% endblock %}

{% block content %}
<div class="create_diary_container_ksy">

    <div class="create_diary_left_container_psy">
        <img src="{{ diary.four_cut_photo.image_file.url }}" alt="ì‚¬ìš©ì ì—…ë¡œë“œ ì‚¬ì§„">
    </div>

    <div class="create_diary_right_container_psy">
        <form class="create_diary_form_psy" method="post" action="{% url 'diaries:edit_diary' diary.id %}">
            {% csrf_token %}
            <div class="first_right_container_psy">
                <div class="first_line_psy">
                    <div class="diary_title_psy">
                        <h1 class="diary_letter_psy">o Title</h1>
                        {{ form.title }}
                    </div>
                    <div class="diary_date_psy">
                        <h1 class="diary_letter_psy">o Date</h1>
                        {{ form.date }}
                    </div>
                </div>

                <div class="second_line_psy">
                    <div class="diary_weather_psy">
                        <h1 class="diary_letter_psy">o Weather</h1>
                        {{ form.weather|safe }}
                    </div>
                    <div class="diary_emotion_psy">
                        <h1 class="diary_letter_psy">o Emotion</h1>
                        {{ form.emotion|safe }}
                    </div>
                </div>

                <div class="third_line_psy">

                    <div class="diary_tag_psy">
                        <div class="diary_content_tag_psy">
                            <h1 class="diary_letter_psy">o Tag</h1>
                            <input type="text" name="create_diary_post" placeholder="#ìœ¼ë¡œ íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”" class="content_tag_psy" value="{% for tag in diary.tags.all %}#{{ tag.name }} {% endfor %}" required>
                        </div>
                        <div class="diary_friend_psy">
                            <h1 class="diary_letter_psy">o Friend Tag</h1>
                            {% comment %} ìˆ˜ì •í•œ ë¶€ë¶„ {% endcomment %}
                            {% for user in neighbors %}
                                <div class="friend_tag_item_psy">
                                    <input type="checkbox" name="user_tags" value="{{ user.login_id }}" id="friend_{{ user.login_id }}"
                                        {% if user in form.instance.user_tags.all %}checked{% endif %}>  <!-- ê¸°ì¡´ ì„ íƒëœ ê°’ ìœ ì§€ -->
                                    <label for="friend_{{ user.login_id }}">{{ user.nickname }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="diary_map_psy">
                        <h1 class="diary_letter_psy">o Location</h1>
                        {{ form.place }}
                        <!-- ì¥ì†Œ ëª©ë¡ ì¶œë ¥ ì˜ì—­ -->
                        <div class="real_location_psy"></div>
                        <ul id="placesList"></ul>

                    </div>

                </div>
            </div>
            
            <div class="fourth_line_psy">
                <h1 class="diary_letter_psy">o Content</h1>
                {{ form.content }}
            </div>

            <button type="submit" class="diary_save_psy">
                <span>Save</span>
            </button>
        </form>
        
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // ëª¨ë“  ì¹œêµ¬ íƒœê·¸ ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
        let friendTags = document.querySelectorAll(".friend_tag_item_psy");

        friendTags.forEach(function(tagItem) {
            let checkbox = tagItem.querySelector("input[type='checkbox']");
            
            // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ì²´í¬ë˜ì—ˆì„ ê²½ìš° ìƒ‰ìƒ ë³€ê²½)
            if (checkbox.checked) {
                tagItem.classList.add("selected");
            }

            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            tagItem.addEventListener("click", function() {
                checkbox.checked = !checkbox.checked; // ì²´í¬ ìƒíƒœ í† ê¸€

                if (checkbox.checked) {
                    tagItem.classList.add("selected"); // ì„ íƒ ì‹œ ìƒ‰ìƒ ë³€ê²½
                } else {
                    tagItem.classList.remove("selected"); // ì„ íƒ ì·¨ì†Œ ì‹œ ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³€ê²½
                }
            });
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ í•€ ì°ê¸°
        const placeName = document.getElementById("id_place").value;
        console.log(placeName)
        placeSearch(placeName);
    });
    
    document.addEventListener("DOMContentLoaded", function() {
        let inputField = document.querySelector("#id_place");
        let placesList = document.getElementById('placesList');
    
        if (inputField) {
            inputField.addEventListener("input", function() {
                if (this.value.trim()) {
                    placeSearch(this.value);
                } else {
                    placesList.innerHTML = "";  //  ì…ë ¥ ì°½ì´ ë¹„ë©´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
                }
            });
    
            // ğŸ”¹ ì—”í„°í‚¤ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ ì¥ì†Œ ì„ íƒ
            inputField.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    selectTopPlace();
                }
            });
        }
    });
    
    // 1. ì§€ë„ ì´ˆê¸°í™”
    const mapContainer = document.querySelector('.real_location_psy');
    const map = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­ ì¤‘ì‹¬ ì¢Œí‘œ
        level: 6, // ì§€ë„ í™•ëŒ€ ë ˆë²¨
    });
    
    const geocoder = new kakao.maps.services.Geocoder(); // ì£¼ì†Œ ê²€ìƒ‰ ê°ì²´
    const ps = new kakao.maps.services.Places();  // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ ìƒì„±
    let marker;  // ë‹¨ì¼ ë§ˆì»¤ ê´€ë¦¬
    let topPlace = null;  // ğŸ”¹ ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ì¥ì†Œ ì €ì¥
    
    function placeSearch(keyword) {
        ps.keywordSearch(keyword, placesSearchCB);
    }
    
    // í‚¤ì›Œë“œ ê²€ìƒ‰ ì™„ë£Œ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜
    function placesSearchCB(data, status) {
        if (status === kakao.maps.services.Status.OK) {
            displayPlaces(data.slice(0, 3)); // ğŸ”¹ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ 3ê°œë§Œ í‘œì‹œ
            topPlace = data[0]; // ğŸ”¹ ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ì¥ì†Œ ì €ì¥
        }
    }
    
    // ğŸ”¹ ì—”í„°ë¥¼ ëˆ„ë¥´ë©´ ê°€ì¥ ê°€ëŠ¥ì„± ë†’ì€ ì¥ì†Œ ìë™ ì„ íƒ
    function selectTopPlace() {
        if (topPlace) {
            addLocation(topPlace.address_name);
        } else {
            alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
    // 2. ê²€ìƒ‰ëœ ì¥ì†Œ ëª©ë¡ì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ìµœëŒ€ 3ê°œë§Œ)
    function displayPlaces(places) {
        placesList.innerHTML = ""; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì‚­ì œ
    
        places.forEach((place, index) => {
            const itemEl = document.createElement('li');
            itemEl.innerHTML = `
                <span class="markerbg marker_${index+1}"></span>
                <div class="info">
                    <h5>${place.place_name}</h5>
                    <span>${place.road_address_name || place.address_name}</span>
                </div>
            `;
    
            itemEl.onclick = function() {
                addLocation(place.address_name);
            };
            placesList.appendChild(itemEl);
        });
    }
    
    // 3. ì„ íƒí•œ ì¥ì†Œë¥¼ ì§€ë„ì— ë§ˆì»¤ë¡œ í‘œì‹œ & ì…ë ¥ í•„ë“œì— ë°˜ì˜
    function addLocation(address) {
        if (!address) {
            alert('ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
    
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
    
                // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ í›„ ìƒˆë¡œìš´ ë§ˆì»¤ ì¶”ê°€
                if (marker) {
                    marker.setMap(null);
                }
                marker = new kakao.maps.Marker({ position: coords });
                marker.setMap(map);
    
                // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                map.panTo(coords);
    
                // ì„ íƒí•œ ì£¼ì†Œë¥¼ ì…ë ¥ í•„ë“œì— ìë™ ë°˜ì˜
                document.getElementById("create_diary_real_address").value = address;
            } else {
                alert('ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        });
    }
    </script>
    

    

{% endblock %}
