{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_MAP_APPKEY_JS}}&libraries=services"></script>
<link rel="stylesheet" href="{% static 'diaries/edit_diary.css' %}">
{% endblock %}

{% block content %}
<div class="create_diary_container_ksy">

    <div class="create_diary_left_container_psy">
        <img src="{{ diary.four_cut_photo.image_file.url }}" alt="ì‚¬ìš©ì ì—…ë¡œë“œ ì‚¬ì§„">
    </div>

    <div class="create_diary_right_container_psy">
        <form class="create_diary_form_psy" method="post" action="{% url 'diaries:edit_diary' diary.id %}">
            {% csrf_token %}
            <input type="hidden" id="create_diary_real_address" name="place_address">
            <div class="first_right_container_psy">
                <div class="first_line_psy">
                    <div class="diary_title_psy">
                        <h1 class="diary_letter_psy">o Title</h1>
                        {{ form.title }}
                    </div>
                    <div class="diary_date_psy">
                        <h1 class="diary_letter_psy">o Date</h1>
                        {{ form.date }}
                    </div>
                </div>

                <div class="second_line_psy">
                    <div class="diary_weather_psy">
                        <h1 class="diary_letter_psy">o Weather</h1>
                        {{ form.weather|safe }}
                    </div>
                    <div class="diary_emotion_psy">
                        <h1 class="diary_letter_psy">o Emotion</h1>
                        {{ form.emotion|safe }}
                    </div>
                </div>

                <div class="third_line_psy">

                    <div class="diary_tag_psy">
                        <div class="diary_content_tag_psy">
                            <h1 class="diary_letter_psy">o Tag</h1>
                            <input type="text" name="create_diary_post" placeholder="#ìœ¼ë¡œ íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”" class="content_tag_psy" value="{% for tag in diary.tags.all %}#{{ tag.name }} {% endfor %}" required>
                        </div>
                        <div class="diary_friend_psy">
                            <h1 class="diary_letter_psy">o Friend Tag</h1>
                            {% comment %} ìˆ˜ì •í•œ ë¶€ë¶„ {% endcomment %}
                            {% for user in neighbors %}
                                <div class="friend_tag_item_psy">
                                    <input type="checkbox" name="user_tags" value="{{ user.login_id }}" id="friend_{{ user.login_id }}"
                                        {% if user in form.instance.user_tags.all %}checked{% endif %}>  <!-- ê¸°ì¡´ ì„ íƒëœ ê°’ ìœ ì§€ -->
                                    <label for="friend_{{ user.login_id }}">{{ user.nickname }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="diary_map_psy">
                        <h1 class="diary_letter_psy">o Location</h1>
                        {{ form.place }}
                        <ul id="placesList"></ul>
                        <div class="real_location_psy"></div>
                    </div>

                </div>
            </div>
            
            <div class="fourth_line_psy">
                <h1 class="diary_letter_psy">o Content</h1>
                {{ form.content }}
            </div>

            <button type="submit" class="diary_save_psy">
                <span>Save</span>
            </button>
        </form>
        
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const inputField = document.querySelector("#id_place");
        const placesList = document.getElementById("placesList");
        const mapContainer = document.querySelector('.real_location_psy');
        const geocoder = new kakao.maps.services.Geocoder();
        const ps = new kakao.maps.services.Places();
        let marker;
        let topPlace = null;
        const map = new kakao.maps.Map(mapContainer, {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­ ì¤‘ì‹¬ ì¢Œí‘œ
            level: 6 // ì§€ë„ í™•ëŒ€ ë ˆë²¨
        });

        // ğŸ”¹ ì¹œêµ¬ íƒœê·¸ ìƒ‰ìƒ ë³€ê²½ ê¸°ëŠ¥
        const friendTags = document.querySelectorAll(".friend_tag_item_psy");
        friendTags.forEach(function(tagItem) {
            const checkbox = tagItem.querySelector("input[type='checkbox']");

            // ì´ˆê¸° ìƒíƒœ ì„¤ì • (ì²´í¬ëœ ê²½ìš° selected í´ë˜ìŠ¤ ì¶”ê°€)
            if (checkbox.checked) {
                tagItem.classList.add("selected");
            }

            tagItem.addEventListener("click", function() {
                checkbox.checked = !checkbox.checked; // ì²´í¬ ìƒíƒœ í† ê¸€
                tagItem.classList.toggle("selected", checkbox.checked); // ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ í´ë˜ìŠ¤ í† ê¸€
            });
        });

        // ğŸ”¹ ì¥ì†Œ ê²€ìƒ‰ ë° ëª©ë¡ í‘œì‹œ
        inputField.addEventListener("focus", function() {
            if (placesList.innerHTML.trim() !== "") {
                placesList.style.display = "block";
            }
        });

        inputField.addEventListener("input", function() {
            const keyword = this.value.trim();
            if (keyword) {
                placeSearch(keyword);
            } else {
                placesList.innerHTML = "";
                placesList.style.display = "none";
            }
        });

        function placeSearch(keyword) {
            ps.keywordSearch(keyword, function(data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    topPlace = data[0];
                    displayPlaces(data.slice(0, 3)); // ìµœëŒ€ 3ê°œë§Œ í‘œì‹œ
                    placesList.style.display = "block";
                } else {
                    placesList.style.display = "none";
                }
            });
        }

        function displayPlaces(places) {
            placesList.innerHTML = "";
            places.forEach((place, index) => {
                const itemEl = document.createElement("li");
                itemEl.innerHTML = `
                    <div class="info">
                        <h5>${place.place_name}</h5>
                        <span>${place.road_address_name || place.address_name}</span>
                    </div>
                `;
                itemEl.addEventListener("click", function() {
                    addLocation(place.address_name);
                    placesList.style.display = "none"; // ì¥ì†Œ í´ë¦­ ì‹œ ëª©ë¡ ìˆ¨ê¸°ê¸°
                });
                placesList.appendChild(itemEl);
            });
        }

        // ğŸ”¹ ì„ íƒí•œ ì¥ì†Œ ì§€ë„ì— ë§ˆì»¤ë¡œ í‘œì‹œ
        function addLocation(address) {
            if (!address) {
                alert('ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            geocoder.addressSearch(address, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    if (marker) {
                        marker.setMap(null);
                    }
                    marker = new kakao.maps.Marker({ position: coords });
                    marker.setMap(map);
                    map.panTo(coords);
                    document.getElementById("create_diary_real_address").value = address;
                }
            });
        }

        // ğŸ”¹ ì—”í„°í‚¤ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ ì¥ì†Œ ì„ íƒ
        inputField.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                if (topPlace) {
                    addLocation(topPlace.address_name);
                    placesList.style.display = "none";
                } else {
                    alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            }
        });
    });
</script>


{% endblock %}
