{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{KAKAO_MAP_APPKEY_JS}}&libraries=services"></script>
<link rel="stylesheet" href="{% static 'diaries/edit_diary.css' %}">
{% endblock %}

{% block content %}
<div class="create_diary_container_ksy">

    <div class="create_diary_left_container_psy">
        <img src="{{ diary.four_cut_photo.image_file.url }}" alt="사용자 업로드 사진">
    </div>

    <div class="create_diary_right_container_psy">
        <form class="create_diary_form_psy" method="post" action="{% url 'diaries:edit_diary' diary.id %}">
            {% csrf_token %}
            <div class="first_right_container_psy">
                <div class="first_line_psy">
                    <div class="diary_title_psy">
                        <h1 class="diary_letter_psy">o Title</h1>
                        {{ form.title }}
                    </div>
                    <div class="diary_date_psy">
                        <h1 class="diary_letter_psy">o Date</h1>
                        {{ form.date }}
                    </div>
                </div>

                <div class="second_line_psy">
                    <div class="diary_weather_psy">
                        <h1 class="diary_letter_psy">o Weather</h1>
                        {{ form.weather|safe }}
                    </div>
                    <div class="diary_emotion_psy">
                        <h1 class="diary_letter_psy">o Emotion</h1>
                        {{ form.emotion|safe }}
                    </div>
                </div>

                <div class="third_line_psy">

                    <div class="diary_tag_psy">
                        <div class="diary_content_tag_psy">
                            <h1 class="diary_letter_psy">o Tag</h1>
                            <input type="text" name="create_diary_post" placeholder="#으로 태그를 추가하세요" class="content_tag_psy" value="{% for tag in diary.tags.all %}#{{ tag.name }} {% endfor %}" required>
                        </div>
                        <div class="diary_friend_psy">
                            <h1 class="diary_letter_psy">o Friend Tag</h1>
                            {% comment %} 수정한 부분 {% endcomment %}
                            {% for user in neighbors %}
                                <div class="friend_tag_item_psy">
                                    <input type="checkbox" name="user_tags" value="{{ user.login_id }}" id="friend_{{ user.login_id }}"
                                        {% if user in form.instance.user_tags.all %}checked{% endif %}>  <!-- 기존 선택된 값 유지 -->
                                    <label for="friend_{{ user.login_id }}">{{ user.nickname }}</label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="diary_map_psy">
                        <h1 class="diary_letter_psy">o Location</h1>
                        {{ form.place }}
                        <!-- 장소 목록 출력 영역 -->
                        <div class="real_location_psy"></div>
                        <ul id="placesList"></ul>

                    </div>

                </div>
            </div>
            
            <div class="fourth_line_psy">
                <h1 class="diary_letter_psy">o Content</h1>
                {{ form.content }}
            </div>

            <button type="submit" class="diary_save_psy">
                <span>Save</span>
            </button>
        </form>
        
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 모든 친구 태그 요소를 가져옴
        let friendTags = document.querySelectorAll(".friend_tag_item_psy");

        friendTags.forEach(function(tagItem) {
            let checkbox = tagItem.querySelector("input[type='checkbox']");
            
            // 초기 상태 설정 (체크되었을 경우 색상 변경)
            if (checkbox.checked) {
                tagItem.classList.add("selected");
            }

            // 클릭 이벤트 추가
            tagItem.addEventListener("click", function() {
                checkbox.checked = !checkbox.checked; // 체크 상태 토글

                if (checkbox.checked) {
                    tagItem.classList.add("selected"); // 선택 시 색상 변경
                } else {
                    tagItem.classList.remove("selected"); // 선택 취소 시 원래 색으로 변경
                }
            });
        });

        // 페이지 로드 시 지도 핀 찍기
        const placeName = document.getElementById("id_place").value;
        console.log(placeName)
        placeSearch(placeName);
    });
    
    document.addEventListener("DOMContentLoaded", function() {
        let inputField = document.querySelector("#id_place");
        let placesList = document.getElementById('placesList');
    
        if (inputField) {
            inputField.addEventListener("input", function() {
                if (this.value.trim()) {
                    placeSearch(this.value);
                } else {
                    placesList.innerHTML = "";  //  입력 창이 비면 리스트 초기화
                }
            });
    
            // 🔹 엔터키 입력 시 자동으로 가장 관련성 높은 장소 선택
            inputField.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    selectTopPlace();
                }
            });
        }
    });
    
    // 1. 지도 초기화
    const mapContainer = document.querySelector('.real_location_psy');
    const map = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울시청 중심 좌표
        level: 6, // 지도 확대 레벨
    });
    
    const geocoder = new kakao.maps.services.Geocoder(); // 주소 검색 객체
    const ps = new kakao.maps.services.Places();  // 장소 검색 객체 생성
    let marker;  // 단일 마커 관리
    let topPlace = null;  // 🔹 가장 가능성 높은 장소 저장
    
    function placeSearch(keyword) {
        ps.keywordSearch(keyword, placesSearchCB);
    }
    
    // 키워드 검색 완료 시 호출되는 콜백함수
    function placesSearchCB(data, status) {
        if (status === kakao.maps.services.Status.OK) {
            displayPlaces(data.slice(0, 3)); // 🔹 가장 관련성 높은 3개만 표시
            topPlace = data[0]; // 🔹 가장 가능성 높은 장소 저장
        }
    }
    
    // 🔹 엔터를 누르면 가장 가능성 높은 장소 자동 선택
    function selectTopPlace() {
        if (topPlace) {
            addLocation(topPlace.address_name);
        } else {
            alert("검색 결과가 없습니다.");
        }
    }
    
    // 2. 검색된 장소 목록을 화면에 표시하는 함수 (최대 3개만)
    function displayPlaces(places) {
        placesList.innerHTML = ""; // 기존 리스트 삭제
    
        places.forEach((place, index) => {
            const itemEl = document.createElement('li');
            itemEl.innerHTML = `
                <span class="markerbg marker_${index+1}"></span>
                <div class="info">
                    <h5>${place.place_name}</h5>
                    <span>${place.road_address_name || place.address_name}</span>
                </div>
            `;
    
            itemEl.onclick = function() {
                addLocation(place.address_name);
            };
            placesList.appendChild(itemEl);
        });
    }
    
    // 3. 선택한 장소를 지도에 마커로 표시 & 입력 필드에 반영
    function addLocation(address) {
        if (!address) {
            alert('장소를 찾을 수 없습니다.');
            return;
        }
    
        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
    
                // 기존 마커 삭제 후 새로운 마커 추가
                if (marker) {
                    marker.setMap(null);
                }
                marker = new kakao.maps.Marker({ position: coords });
                marker.setMap(map);
    
                // 지도 중심 이동
                map.panTo(coords);
    
                // 선택한 주소를 입력 필드에 자동 반영
                document.getElementById("create_diary_real_address").value = address;
            } else {
                alert('장소를 찾을 수 없습니다.');
            }
        });
    }
    </script>
    

    

{% endblock %}
