{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <meta name="csrf_token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="{% static 'diaries/friend_request.css' %}">
{% endblock %}

{% block content %}
<div class="friend_container_ksy">
    <!-- 검색 영역 -->
    <div class="friend_search-container_ksy">
        <form class="friend_search-form_ksy" >
            {% csrf_token %}
            <input type="text" class="friend_search-input_ksy" placeholder="@으로 검색해주세요" required>
            <button type="submit" class="friend_search-button-container_ksy">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="friend_search-button_ksy" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                  </svg>
            </button>
        </form>
    </div>
    <div class="friend_search-result_kes">

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.querySelector(".friend_search-input_ksy");
        const resultsContainer = document.querySelector(".friend_search-result_kes");

        const searchResultItemClassName = "user_search_result_item_kes";    // 모든 검색된 아이템 컨테이너div 클래스명
        const profileImageClassName = "user_search_result_item_profileimage_kes";   // 검색결과 프사 이미지 클래스명
        const userNicknameClassName = "user_search_result_item_nickname_kes";       // 검색결과 닉네임 클래스명
        const friendRequestButtonClassName = "user_search_request_button_kes"; // '친구 추가' 버튼 클래스명
        const noResultTextClassName = "user_search_no_result_text_kes"; // 검색결과 없을 때 뜨는 텍스트 클래스명

        searchInput.addEventListener("input", function () {
            const query = searchInput.value.trim();
            if (query === "") {
                resultsContainer.innerHTML = "";  // 검색어 없으면 결과 초기화
                return;
            }

            fetch(`/search_ajax/?query=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    return response.json();
                })
                .then(data => {
                    resultsContainer.innerHTML = "";  // 기존 결과 초기화
                    if (data.result.length > 0) {
                        data.result.forEach(user => {
                            console.log(user)
                            const userElement = document.createElement("div");
                            userElement.className = searchResultItemClassName;
                            userElement.innerHTML = `
                                <img class="${profileImageClassName}" src="/media/${user.profile_photo}" alt="프로필 사진"/>
                                <p class="${userNicknameClassName}">${user.nickname}</p>
                                <button onclick="FriendRequestOnClick('${user.login_id}')" class="${friendRequestButtonClassName}">친구 추가</button>
                            `;
                            resultsContainer.appendChild(userElement);
                        });
                    } else {
                        resultsContainer.innerHTML = `<p class="${noResultTextClassName}">검색 결과가 없습니다.</p>`;
                    }
                })
                .catch(error => {
                    console.error("Error fetching posts:", error);
                });
        });
    });
    function FriendRequestOnClick(targetloginId) {
        var csrftoken = document.querySelector("meta[name=csrf_token]").content;
        fetch(`/send_friend_request_ajax/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": csrftoken,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              to_user_loginid: targetloginId,
            }),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            })
            .then(data => {
                if(data.success) {
                    alert("성공: " + data.message);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error("Error fetching posts:", error);
            });
    }
</script>
{% endblock %}