{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'users/main.css' %}">
{% endblock %}

{% block content %}
<div class="main-container_psy">
    <div class="calendar-wrapper_psy">
        <div class="calendar_psy">
            <div class="month_psy">
                <span id="prevMonth_psy">&lt;</span>
                <h2 id="currentMonth_psy"></h2>
                <span id="nextMonth_psy">&gt;</span>
            </div>

            <div class="weekdays_psy">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>

            <div class="days_psy" id="days_psy"></div>
        </div>
    </div>

    <div class="today_diary_psy">
        <div class="diary_list_left_psy">
            <div class="today_diary_list_psy">
                <h3>ì˜¤ëŠ˜ ì“´ ì¼ê¸°</h3>
                <ul id="todayDiaryListContainer"></ul>
            </div>
            <div class="selected_diary_list_psy">
                <h3 id="selectedDate">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
                <ul id="SelecteddiaryListContainer"></ul>
            </div>
        </div>
        <div class="diary_list_right_psy">
            <div class="last_week_diary_list_psy">
                <h3>ì´ë²ˆì£¼ì— ì“´ ì¼ê¸°</h3>
                <ul id="lastWeekDiaryListContainer"></ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const todayDiaryListContainer = document.getElementById("todayDiaryListContainer");
    const lastWeekDiaryListContainer = document.getElementById("lastWeekDiaryListContainer");
    const selectedDateTitle = document.getElementById("selectedDate");
    const selectedDiaryListContainer = document.getElementById("SelecteddiaryListContainer");

    function fetchDiaries(url, container) {
        fetch(url, {
            method: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            },
        })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ ë°ì´í„°:", data);
                updateDiaryList(data, container);
            })
            .catch(error => {
                console.error("âŒ AJAX ìš”ì²­ ì˜¤ë¥˜:", error);
            });
    }

    function updateDiaryList(diaries, container) {
        container.innerHTML = ""; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

        if (diaries.length === 0) {
            container.innerHTML = "<li>ğŸ“Œ ì‘ì„±ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
        } else {
            diaries.forEach(diary => {
                const listItem = document.createElement("li");

                // `innerHTML`ì„ ì‚¬ìš©í•´ ë§í¬ì™€ ì‘ì„±ì¼ì„ í¬í•¨
                listItem.innerHTML = `
                    <a href="/diary/detail/${diary.id}/" style="text-decoration: none;">
                        <strong>${diary.title}</strong>
                    </a>
                    <span> - ì‘ì„±ì¼: ${diary.date || 'ì˜¤ëŠ˜'}</span>
                `;

                container.appendChild(listItem);
            });
        }
    }

    function handleDateClick(year, month, day) {
        const url = `/diary/by_date/${year}/${month + 1}/${day}/`;

        fetch(url, {
            method: "GET",
            headers: {
                "X-Requested-With": "XMLHttpRequest",
            },
        })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“Œ ì„ íƒí•œ ë‚ ì§œì˜ ì¼ê¸° ë°ì´í„°:", data);
                updateDiaryList(data, selectedDiaryListContainer);
                selectedDateTitle.textContent = `${year}ë…„ ${month + 1}ì›” ${day}ì¼ì— ì“´ ì¼ê¸°`;
            })
            .catch(error => {
                console.error("âŒ AJAX ìš”ì²­ ì˜¤ë¥˜:", error);
            });
    }

    function fetchTodayAndLastWeekDiaries() {
        fetchDiaries("/diary/today/", todayDiaryListContainer);
        fetchDiaries("/diary/last_week/", lastWeekDiaryListContainer);
    }

    fetchTodayAndLastWeekDiaries(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ & ì´ë²ˆ ì£¼ ì¼ê¸° ë¶ˆëŸ¬ì˜¤ê¸°

    const daysContainer = document.getElementById("days_psy");
    const currentMonthElement = document.getElementById("currentMonth_psy");
    const prevMonthButton = document.getElementById("prevMonth_psy");
    const nextMonthButton = document.getElementById("nextMonth_psy");

    let currentDate = new Date();
    let selectedDate = null;

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        currentMonthElement.textContent = new Date(year, month).toLocaleString("ko-KR", { year: "numeric", month: "long" });

        const firstDayIndex = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        const today = new Date();

        daysContainer.innerHTML = "";

        for (let i = 0; i < firstDayIndex; i++) {
            const emptyDiv = document.createElement("div");
            emptyDiv.classList.add("empty");
            daysContainer.appendChild(emptyDiv);
        }

        for (let day = 1; day <= lastDate; day++) {
            const dayElement = document.createElement("div");
            dayElement.classList.add("day_psy");

            const daySpan = document.createElement("span");
            daySpan.textContent = day;
            dayElement.appendChild(daySpan);

            const fullDate = new Date(year, month, day);

            dayElement.addEventListener("click", () => {
                handleDateClick(year, month, day);

                if (selectedDate) {
                    selectedDate.classList.remove("selected");
                }
                dayElement.classList.add("selected");
                selectedDate = dayElement;
            });

            if (
                fullDate.getFullYear() === today.getFullYear() &&
                fullDate.getMonth() === today.getMonth() &&
                fullDate.getDate() === today.getDate()
            ) {
                dayElement.classList.add("today");
            }

            if (fullDate < today) {
                dayElement.classList.add("past");
            }

            daysContainer.appendChild(dayElement);
        }
    }

    prevMonthButton.addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthButton.addEventListener("click", () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    renderCalendar();
});
</script>
{% endblock %}
